# v1.3 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete all remaining workshop feedback items ‚Äî enhanced input flow, session persistence, undo/navigation, content templates, and export improvements.

**Architecture:** Five parallel themes: (A) Enhanced Input Flow with "Tell Me More" and reassess UX, (B) Session State with undo/persistence, (C) UX Polish across all components, (D) Content Templates for Creative Task and audience branching, (E) Export & Data with file support and Word export.

**Tech Stack:** Next.js 14, TypeScript, React, Tailwind CSS, Anthropic Claude API, localStorage (session persistence)

---

## Pre-Implementation Checklist

Before starting ANY task:
1. Read `docs/architecture-map.md` for codebase structure
2. Read `DEVELOPMENT.md` for patterns and rules
3. For UI tasks: Use `frontend-design` skill
4. Types first, then implementation

---

## Theme A: Enhanced Input Flow

### Task A1: Add "Tell Me More" Step After Upload

**Files:**
- Modify: `src/lib/types.ts`
- Modify: `src/app/page.tsx`

**Step 1: Update Step type**

In `src/lib/types.ts`, update the Step type:

```typescript
export type Step = 'upload' | 'tell_me_more' | 'triage' | 'context' | 'gate1_sections' | 'gate_transition' | 'gate2_brand' | 'gate2_audience' | 'gate2_insights' | 'gate2_tenets' | 'gate2_media' | 'output';
```

**Step 2: Add state for pre-triage context**

In `SessionState` interface, add:

```typescript
// Pre-triage "Tell Me More" context
preTellMeMoreContext: string;
```

**Step 3: Update createInitialState**

Add `preTellMeMoreContext: ''` to initial state.

**Step 4: Create renderTellMeMoreStep in page.tsx**

```typescript
function renderTellMeMoreStep() {
  return (
    <div className="space-y-6">
      <div className="text-center pb-6 border-b border-[var(--border-color)]">
        <h2 className="text-2xl font-semibold text-[var(--text-primary)] mb-2">
          So, tell me more...
        </h2>
        <p className="text-[var(--text-secondary)]">
          Before we assess the brief, is there anything else you know?
        </p>
        <p className="text-sm text-[var(--text-muted)] mt-2">
          Call notes, email threads, conversations with the seller, context from travel fairs...
        </p>
      </div>

      <textarea
        value={state.preTellMeMoreContext}
        onChange={(e) => updateState({ preTellMeMoreContext: e.target.value })}
        placeholder="Spill what else you've got ‚Äî this is the therapy couch..."
        className="w-full h-40 p-4 rounded-xl border border-[var(--border-color)] bg-white focus:outline-none focus:ring-2 focus:ring-[var(--expedia-navy)]/20 resize-none"
      />

      <div className="flex gap-3">
        <button
          onClick={() => updateState({ step: 'upload' })}
          className="btn-outline flex-1"
        >
          ‚Üê Back
        </button>
        <button
          onClick={() => {
            // Merge pre-context into additionalContext
            const merged = state.preTellMeMoreContext
              ? `${state.additionalContext}\n\n[Additional context provided before assessment]:\n${state.preTellMeMoreContext}`
              : state.additionalContext;
            updateState({ additionalContext: merged });
            handleTriage();
          }}
          className="btn-secondary flex-1"
        >
          Assess Brief ‚Üí
        </button>
        <button
          onClick={handleTriage}
          className="text-sm text-[var(--text-muted)] hover:text-[var(--text-primary)]"
        >
          Skip for now
        </button>
      </div>
    </div>
  );
}
```

**Step 5: Update handleFileContent to go to tell_me_more**

Change the file upload handler to navigate to `tell_me_more` instead of calling `handleTriage()` directly.

**Step 6: Add case to renderStep switch**

```typescript
case 'tell_me_more':
  return renderTellMeMoreStep();
```

**Step 7: Update GlobalProgressBar steps array**

Add `{ key: 'tell_me_more', label: 'Context' }` after upload.

**Step 8: Test manually**

Run: `npm run dev`
Test: Upload brief ‚Üí should see "Tell Me More" step ‚Üí can skip or add context ‚Üí triage

**Step 9: Commit**

```bash
git add src/lib/types.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(flow): add Tell Me More step before triage

- New step between upload and triage
- Captures soft context (call notes, email threads)
- Option to skip or add context
- Merged into additionalContext for assessment

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task A2: Add Reassess Button with Visual Confirmation

**Files:**
- Modify: `src/app/page.tsx`
- Modify: `src/lib/types.ts`

**Step 1: Add reassessCount to SessionState**

In `src/lib/types.ts`, add to SessionState:

```typescript
// Track reassessments for visual feedback
reassessCount: number;
lastReassessedAt: string | null;
```

**Step 2: Update createInitialState**

Add `reassessCount: 0, lastReassessedAt: null`.

**Step 3: Create ReassessConfirmation component in page.tsx**

```typescript
function ReassessConfirmation({ count, timestamp }: { count: number; timestamp: string | null }) {
  if (count === 0 || !timestamp) return null;

  return (
    <div
      className="flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--status-green)]/10 text-[var(--status-green)] text-sm"
      style={{ animation: 'slideIn 0.3s ease-out' }}
    >
      <span>‚úì</span>
      <span>Reassessed with new context ({count}x)</span>
      <style jsx>{`
        @keyframes slideIn {
          from { opacity: 0; transform: translateX(-10px); }
          to { opacity: 1; transform: translateX(0); }
        }
      `}</style>
    </div>
  );
}
```

**Step 4: Update handleSectionReassess**

After successful reassess, update state:

```typescript
updateState({
  reassessCount: state.reassessCount + 1,
  lastReassessedAt: new Date().toISOString(),
  // ... other updates
});
```

**Step 5: Add prominent Reassess button in triage view**

In the triage step rendering, add after the additional context textarea:

```typescript
<button
  onClick={() => handleTriageReassess()}
  disabled={!state.additionalContext || state.loading}
  className="btn-secondary flex items-center gap-2"
>
  <span>üîÑ</span>
  Reassess with New Context
</button>

<ReassessConfirmation
  count={state.reassessCount}
  timestamp={state.lastReassessedAt}
/>
```

**Step 6: Create handleTriageReassess function**

```typescript
const handleTriageReassess = async () => {
  updateState({ loading: true, error: null });
  try {
    const response = await fetch('/api/triage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        brief: state.brief,
        additionalContext: state.additionalContext,
      }),
    });
    const data = await response.json();
    updateState({
      loading: false,
      triageResult: data,
      reassessCount: state.reassessCount + 1,
      lastReassessedAt: new Date().toISOString(),
    });
  } catch (err) {
    updateState({ loading: false, error: 'Failed to reassess' });
  }
};
```

**Step 7: Test manually**

Run: `npm run dev`
Test: Upload ‚Üí Triage ‚Üí Add context ‚Üí Click Reassess ‚Üí Should see visual confirmation

**Step 8: Commit**

```bash
git add src/lib/types.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(triage): add Reassess button with visual confirmation

- Track reassessCount and lastReassessedAt in state
- Show visual confirmation when reassess completes
- Clear feedback that NEW INFO has been incorporated

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task A3: Add Research Prompt Suggestions

**Files:**
- Create: `src/lib/research-prompts.ts`
- Modify: `src/app/page.tsx`

**Step 1: Create research prompts config**

Create `src/lib/research-prompts.ts`:

```typescript
// Suggested prompts for users to run in their own LLM

export interface ResearchPrompt {
  id: string;
  title: string;
  prompt: string;
  forGaps: string[]; // Which section gaps this addresses
}

export const RESEARCH_PROMPTS: ResearchPrompt[] = [
  {
    id: 'audience_research',
    title: 'Audience Deep-Dive',
    prompt: `I'm working on a travel campaign targeting [AUDIENCE]. Help me understand:
1. What are their key travel motivations and pain points?
2. What makes them different from generic "travellers"?
3. What cultural or generational factors shape their travel choices?
4. What are 3-5 surprising or counterintuitive insights about this audience?`,
    forGaps: ['audience'],
  },
  {
    id: 'destination_context',
    title: 'Destination Context',
    prompt: `Tell me about [DESTINATION] from a travel marketing perspective:
1. What's the current perception vs reality?
2. What makes it unique compared to competing destinations?
3. What are emerging travel trends for this region?
4. What do travellers often get wrong about this place?`,
    forGaps: ['objective', 'creative_task'],
  },
  {
    id: 'competitor_landscape',
    title: 'Competitor Analysis',
    prompt: `Analyze the travel marketing landscape for [BRAND/DESTINATION]:
1. What are competitors doing well?
2. What gaps exist in how this destination/brand is marketed?
3. What creative approaches haven't been tried?
4. What would make a campaign stand out?`,
    forGaps: ['creative_task', 'objective'],
  },
  {
    id: 'budget_reality',
    title: 'Budget Reality Check',
    prompt: `I have a campaign budget of [AMOUNT] for [OBJECTIVE]. Help me understand:
1. Is this realistic for the stated goals?
2. What could we actually achieve with this budget?
3. What trade-offs should we consider?
4. What's a more realistic objective if budget is fixed?`,
    forGaps: ['budget', 'objective'],
  },
];

export function getSuggestedPrompts(gaps: string[]): ResearchPrompt[] {
  return RESEARCH_PROMPTS.filter((p) =>
    p.forGaps.some((g) => gaps.includes(g))
  );
}
```

**Step 2: Create ResearchSuggestions component**

In `src/app/page.tsx`, add:

```typescript
import { getSuggestedPrompts, ResearchPrompt } from '@/lib/research-prompts';

function ResearchSuggestions({ gaps }: { gaps: string[] }) {
  const prompts = getSuggestedPrompts(gaps);
  const [expanded, setExpanded] = useState<string | null>(null);
  const [copied, setCopied] = useState<string | null>(null);

  if (prompts.length === 0) return null;

  const copyPrompt = (prompt: ResearchPrompt) => {
    navigator.clipboard.writeText(prompt.prompt);
    setCopied(prompt.id);
    setTimeout(() => setCopied(null), 2000);
  };

  return (
    <div className="p-4 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)]">
      <h4 className="font-medium text-[var(--text-primary)] mb-2 flex items-center gap-2">
        <span>üí°</span>
        Try asking an LLM
      </h4>
      <p className="text-sm text-[var(--text-muted)] mb-3">
        Use these prompts in ChatGPT, Claude, or your preferred AI to gather context:
      </p>
      <div className="space-y-2">
        {prompts.map((p) => (
          <div key={p.id} className="border border-[var(--border-color)] rounded-lg overflow-hidden">
            <button
              onClick={() => setExpanded(expanded === p.id ? null : p.id)}
              className="w-full px-3 py-2 text-left text-sm font-medium text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] flex justify-between items-center"
            >
              {p.title}
              <span>{expanded === p.id ? '‚ñº' : '‚ñ∂'}</span>
            </button>
            {expanded === p.id && (
              <div className="px-3 py-2 bg-white border-t border-[var(--border-color)]">
                <pre className="text-xs text-[var(--text-secondary)] whitespace-pre-wrap mb-2">
                  {p.prompt}
                </pre>
                <button
                  onClick={() => copyPrompt(p)}
                  className="text-xs text-[var(--expedia-navy)] hover:underline"
                >
                  {copied === p.id ? '‚úì Copied!' : 'Copy prompt'}
                </button>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

**Step 3: Add to triage step**

In the triage step rendering, after showing sections with amber/red status:

```typescript
{/* Research suggestions based on gaps */}
<ResearchSuggestions
  gaps={state.triageResult?.triageAssessment
    .filter(s => s.status !== 'green')
    .map(s => s.key) || []}
/>
```

**Step 4: Test manually**

Run: `npm run dev`
Test: Upload brief with gaps ‚Üí See research prompt suggestions ‚Üí Can expand and copy

**Step 5: Commit**

```bash
git add src/lib/research-prompts.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(triage): add research prompt suggestions

- Suggest LLM prompts based on identified gaps
- Expandable prompt cards with copy functionality
- Encourages human research (not automated)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task A4: Multi-Document Upload

**Files:**
- Modify: `src/components/FileUpload.tsx`
- Modify: `src/lib/file-parser.ts`

**Step 1: Update FileUpload to accept multiple files**

In `src/components/FileUpload.tsx`, update the input:

```typescript
<input
  type="file"
  multiple
  accept=".txt,.doc,.docx,.pdf,.ppt,.pptx"
  onChange={handleFileChange}
  // ...
/>
```

**Step 2: Update handleFileChange for multiple files**

```typescript
const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = Array.from(e.target.files || []);
  if (files.length === 0) return;

  setProcessing(true);
  setError(null);

  try {
    const contents: string[] = [];
    const filenames: string[] = [];

    for (const file of files) {
      const content = await parseFile(file);
      contents.push(content);
      filenames.push(file.name);
    }

    const combinedContent = contents
      .map((content, i) => `--- ${filenames[i]} ---\n${content}`)
      .join('\n\n');

    onFileContent(combinedContent, filenames.join(', '));
    setProcessing(false);
    setSuccess(true);
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to parse files');
    setProcessing(false);
  }
};
```

**Step 3: Update UI to show multiple file support**

Update the upload zone text:

```typescript
<p className="text-[var(--text-secondary)] mt-2">
  Drop files here or click to browse
</p>
<p className="text-xs text-[var(--text-muted)] mt-1">
  Supports .docx, .pdf, .pptx, .txt ‚Äî multiple files OK
</p>
```

**Step 4: Show file list when multiple uploaded**

```typescript
{filenames.length > 1 && (
  <div className="mt-3 text-sm text-[var(--text-muted)]">
    <p className="font-medium">{filenames.length} files combined:</p>
    <ul className="list-disc list-inside">
      {filenames.map((f, i) => <li key={i}>{f}</li>)}
    </ul>
  </div>
)}
```

**Step 5: Test manually**

Run: `npm run dev`
Test: Upload 2-3 files at once ‚Üí Should combine into single brief

**Step 6: Commit**

```bash
git add src/components/FileUpload.tsx && git commit -m "$(cat <<'EOF'
feat(upload): support multi-document upload

- Accept multiple files at once
- Combine into single brief with file markers
- Show list of uploaded files

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task A5: URL Handling Guidance

**Files:**
- Modify: `src/components/FileUpload.tsx`

**Step 1: Add URL guidance text**

In the FileUpload component, add after the file type support text:

```typescript
<div className="mt-4 p-3 rounded-lg bg-[var(--bg-tertiary)] text-xs text-[var(--text-muted)]">
  <p className="font-medium mb-1">üí° About hyperlinks</p>
  <p>
    If your brief contains links, open them and copy the content manually.
    The tool can't access password-protected pages or content behind logins.
  </p>
</div>
```

**Step 2: Commit**

```bash
git add src/components/FileUpload.tsx && git commit -m "$(cat <<'EOF'
feat(upload): add URL handling guidance

- Inform users to manually copy linked content
- Note about login/password limitations

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Theme B: Session & State Management

### Task B1: Implement Undo Functionality

**Files:**
- Modify: `src/lib/types.ts`
- Modify: `src/app/page.tsx`

**Step 1: Add history stack to types**

In `src/lib/types.ts`, add:

```typescript
export interface HistoryEntry {
  timestamp: string;
  action: string;
  state: Partial<SessionState>;
}
```

**Step 2: Add history to SessionState**

```typescript
// Undo history
history: HistoryEntry[];
historyIndex: number;
```

**Step 3: Update createInitialState**

Add `history: [], historyIndex: -1`.

**Step 4: Create pushHistory helper**

In `page.tsx`:

```typescript
const pushHistory = (action: string, snapshot: Partial<SessionState>) => {
  const entry: HistoryEntry = {
    timestamp: new Date().toISOString(),
    action,
    state: snapshot,
  };

  // Trim future history if we're not at the end
  const newHistory = state.history.slice(0, state.historyIndex + 1);
  newHistory.push(entry);

  // Keep max 20 entries
  if (newHistory.length > 20) newHistory.shift();

  updateState({
    history: newHistory,
    historyIndex: newHistory.length - 1,
  });
};
```

**Step 5: Create undo/redo functions**

```typescript
const canUndo = state.historyIndex > 0;
const canRedo = state.historyIndex < state.history.length - 1;

const undo = () => {
  if (!canUndo) return;
  const prevEntry = state.history[state.historyIndex - 1];
  updateState({
    ...prevEntry.state,
    historyIndex: state.historyIndex - 1,
  });
};

const redo = () => {
  if (!canRedo) return;
  const nextEntry = state.history[state.historyIndex + 1];
  updateState({
    ...nextEntry.state,
    historyIndex: state.historyIndex + 1,
  });
};
```

**Step 6: Add undo/redo buttons to UI**

Create UndoRedoButtons component:

```typescript
function UndoRedoButtons() {
  return (
    <div className="fixed bottom-4 right-4 flex gap-2">
      <button
        onClick={undo}
        disabled={!canUndo}
        className="p-2 rounded-lg bg-white border border-[var(--border-color)] shadow-sm disabled:opacity-40"
        title="Undo"
      >
        ‚Ü∂
      </button>
      <button
        onClick={redo}
        disabled={!canRedo}
        className="p-2 rounded-lg bg-white border border-[var(--border-color)] shadow-sm disabled:opacity-40"
        title="Redo"
      >
        ‚Ü∑
      </button>
    </div>
  );
}
```

**Step 7: Add pushHistory calls to key actions**

Before updating state in handlers like `acceptSuggestion`, `handleSectionReassess`, etc.:

```typescript
pushHistory('Accept suggestion', { sections: state.sections });
```

**Step 8: Test manually**

Run: `npm run dev`
Test: Make changes ‚Üí Click undo ‚Üí Should restore previous state

**Step 9: Commit**

```bash
git add src/lib/types.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(ux): implement undo/redo functionality

- History stack with max 20 entries
- Push history before destructive actions
- Fixed position undo/redo buttons

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task B2: Add Save Work Reminder

**Files:**
- Modify: `src/app/page.tsx`

**Step 1: Create SaveReminder component**

```typescript
function SaveReminder({ hasUnsavedWork }: { hasUnsavedWork: boolean }) {
  const [dismissed, setDismissed] = useState(false);

  if (!hasUnsavedWork || dismissed) return null;

  return (
    <div className="fixed bottom-4 left-4 p-4 rounded-xl bg-[var(--expedia-navy)] text-white shadow-lg max-w-xs">
      <div className="flex items-start gap-3">
        <span className="text-lg">üíæ</span>
        <div>
          <p className="font-medium text-sm">Don't forget to save</p>
          <p className="text-xs opacity-80 mt-1">
            This tool doesn't store your work. Download your output before leaving.
          </p>
        </div>
        <button
          onClick={() => setDismissed(true)}
          className="text-white/60 hover:text-white"
        >
          √ó
        </button>
      </div>
    </div>
  );
}
```

**Step 2: Track unsaved work**

Add to state calculation:

```typescript
const hasUnsavedWork = state.step !== 'upload' && state.step !== 'output';
```

**Step 3: Add to page layout**

```typescript
<SaveReminder hasUnsavedWork={hasUnsavedWork} />
```

**Step 4: Commit**

```bash
git add src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(ux): add save work reminder

- Fixed position reminder when work in progress
- Dismissible by user
- Warns that tool doesn't persist sessions

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task B3: Session Persistence with localStorage

**Files:**
- Create: `src/lib/session-storage.ts`
- Modify: `src/app/page.tsx`

**Step 1: Create session storage utilities**

Create `src/lib/session-storage.ts`:

```typescript
import { SessionState, createInitialState } from './types';

const STORAGE_KEY = 'pitch_pack_session';
const SESSION_EXPIRY_HOURS = 24;

export interface StoredSession {
  state: SessionState;
  savedAt: string;
  expiresAt: string;
}

export function saveSession(state: SessionState): void {
  const now = new Date();
  const expiresAt = new Date(now.getTime() + SESSION_EXPIRY_HOURS * 60 * 60 * 1000);

  const session: StoredSession = {
    state,
    savedAt: now.toISOString(),
    expiresAt: expiresAt.toISOString(),
  };

  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
  } catch (e) {
    console.warn('Failed to save session:', e);
  }
}

export function loadSession(): SessionState | null {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return null;

    const session: StoredSession = JSON.parse(stored);

    // Check expiry
    if (new Date(session.expiresAt) < new Date()) {
      clearSession();
      return null;
    }

    return session.state;
  } catch (e) {
    console.warn('Failed to load session:', e);
    return null;
  }
}

export function clearSession(): void {
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch (e) {
    console.warn('Failed to clear session:', e);
  }
}

export function hasStoredSession(): boolean {
  return loadSession() !== null;
}
```

**Step 2: Add auto-save on state changes**

In `page.tsx`, add useEffect:

```typescript
import { saveSession, loadSession, clearSession, hasStoredSession } from '@/lib/session-storage';

// Auto-save on state changes (debounced)
useEffect(() => {
  const timeout = setTimeout(() => {
    if (state.step !== 'upload') {
      saveSession(state);
    }
  }, 1000);
  return () => clearTimeout(timeout);
}, [state]);
```

**Step 3: Add session restore on mount**

```typescript
const [showRestorePrompt, setShowRestorePrompt] = useState(false);

useEffect(() => {
  if (hasStoredSession()) {
    setShowRestorePrompt(true);
  }
}, []);

const restoreSession = () => {
  const saved = loadSession();
  if (saved) {
    setState(saved);
  }
  setShowRestorePrompt(false);
};

const startFresh = () => {
  clearSession();
  setShowRestorePrompt(false);
};
```

**Step 4: Create RestoreSessionPrompt component**

```typescript
function RestoreSessionPrompt({ onRestore, onStartFresh }: { onRestore: () => void; onStartFresh: () => void }) {
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl p-6 max-w-md shadow-xl">
        <h3 className="text-lg font-semibold text-[var(--text-primary)] mb-2">
          Welcome back
        </h3>
        <p className="text-[var(--text-secondary)] mb-4">
          You have a session in progress. Would you like to continue where you left off?
        </p>
        <div className="flex gap-3">
          <button onClick={onStartFresh} className="btn-outline flex-1">
            Start Fresh
          </button>
          <button onClick={onRestore} className="btn-secondary flex-1">
            Continue Session
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Step 5: Add to render**

```typescript
{showRestorePrompt && (
  <RestoreSessionPrompt onRestore={restoreSession} onStartFresh={startFresh} />
)}
```

**Step 6: Clear session on output download**

In the download handler:

```typescript
clearSession();
```

**Step 7: Test manually**

Run: `npm run dev`
Test: Progress through flow ‚Üí Refresh page ‚Üí Should see restore prompt

**Step 8: Commit**

```bash
git add src/lib/session-storage.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(session): implement localStorage persistence

- Auto-save session on state changes (debounced)
- Restore prompt on page load if session exists
- 24-hour expiry
- Clear on output download

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Theme C: UX Polish

### Task C1: Clearer Navigation (Click Section Names)

**Files:**
- Modify: `src/app/page.tsx`

**Step 1: Make section names clickable in triage view**

Update the triage section rendering to make names clickable:

```typescript
{state.triageResult?.triageAssessment.map((section, idx) => (
  <div
    key={section.key}
    className="p-4 rounded-xl border border-[var(--border-color)] cursor-pointer hover:border-[var(--expedia-navy)]/30 transition-colors"
    onClick={() => navigateToSection(idx)}
  >
    {/* ... section content */}
  </div>
))}
```

**Step 2: Create navigateToSection function**

```typescript
const navigateToSection = (index: number) => {
  updateState({
    step: 'gate1_sections',
    currentSectionIndex: index,
  });
};
```

**Step 3: Add visual hint for clickability**

Add to section cards:

```typescript
<p className="text-xs text-[var(--text-muted)] mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
  Click to edit this section ‚Üí
</p>
```

Add `group` class to the container.

**Step 4: Commit**

```bash
git add src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(nav): make section names clickable

- Click any section in triage to jump to editing
- Hover hint shows clickability

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task C2: Complete Wording Changes

**Files:**
- Modify: `src/app/page.tsx`
- Modify: `src/components/*.tsx`

**Step 1: Update all instances of old wording**

Search and replace throughout:

| Old | New |
|-----|-----|
| "Add extra context to improve" | "Continue building" |
| "Paste additional context" | "Tell me more" |
| "Feel free to edit" | "Edit this" |
| "Accept" (for suggestions) | "Use this suggestion" |
| "Dismiss" | "Keep current" |

**Step 2: Commit**

```bash
git add . && git commit -m "$(cat <<'EOF'
refactor(wording): complete terminology updates

- "Continue building" instead of "Add extra context"
- "Tell me more" instead of "Paste additional"
- "Edit this" (active instruction)
- "Use this suggestion" / "Keep current"

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task C3: Add "Keep Refining or Continue" to All Sections

**Files:**
- Modify: `src/app/page.tsx`

**Step 1: Create SectionFooter component**

```typescript
function SectionFooter({
  onRefine,
  onContinue,
  status
}: {
  onRefine: () => void;
  onContinue: () => void;
  status: Status;
}) {
  return (
    <div className="flex items-center justify-between pt-4 mt-4 border-t border-[var(--border-color)]">
      <p className="text-sm text-[var(--text-muted)]">
        {status === 'green' ? 'Looking good!' : 'You can continue even if not perfect.'}
      </p>
      <div className="flex gap-3">
        <button onClick={onRefine} className="btn-outline text-sm">
          Keep refining
        </button>
        <button onClick={onContinue} className="btn-secondary text-sm">
          Confirm & continue ‚Üí
        </button>
      </div>
    </div>
  );
}
```

**Step 2: Add to all section views**

Add `<SectionFooter />` to the bottom of each section step rendering.

**Step 3: Commit**

```bash
git add src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(ux): add Keep Refining / Continue to all sections

- Clear choice at end of each section
- Encourages iteration but allows progress

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task C4: Persona Log Line Naming

**Files:**
- Modify: `src/components/AudienceMenu.tsx`
- Modify: `src/app/api/generate/audience/route.ts`
- Modify: `prompts/audience.json`

**Step 1: Update audience prompt for log line format**

In `prompts/audience.json`, update the segment generation to include a tagline:

```json
"outputs": {
  "segments": "Array of 5 objects with: id, name (e.g. 'The Cultural Curator'), tagline (e.g. 'Collects experiences like currency'), needsValues, demographics"
}
```

**Step 2: Update AudienceSegment type**

In `src/lib/types.ts`:

```typescript
export interface AudienceSegment {
  id: number;
  name: string;
  tagline?: string; // e.g. "Collects experiences like currency"
  needsValues: string;
  demographics: string;
}
```

**Step 3: Update AudienceMenu display**

```typescript
<h3 className="font-semibold text-[var(--text-primary)]">
  {segment.name}
</h3>
{segment.tagline && (
  <p className="text-sm text-[var(--text-muted)] italic">
    "{segment.tagline}"
  </p>
)}
```

**Step 4: Commit**

```bash
git add src/lib/types.ts src/components/AudienceMenu.tsx prompts/audience.json src/app/api/generate/audience/route.ts && git commit -m "$(cat <<'EOF'
feat(audience): add persona log line taglines

- Segments now have name + tagline format
- e.g. "The Cultural Curator - Collects experiences like currency"
- More memorable and descriptive

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task C5: Personification Concise Mode

**Files:**
- Modify: `prompts/audience.json`
- Modify: `src/components/PersonificationReview.tsx`

**Step 1: Update personify prompt for concise output**

In `prompts/audience.json`, update the personify section:

```json
"personify": {
  "logic": "Generate a CONCISE personification (150-200 words max). This is a thinking tool, not final output. Focus on:\n- Key motivations and values\n- Travel decision drivers\n- What makes them tick\n\nAvoid: lengthy backstories, excessive detail, poetic language.",
  // ...
}
```

**Step 2: Update PersonificationReview prompt text**

Change "Feel free to edit this" to:

```typescript
<p className="text-sm text-[var(--text-muted)] mb-3">
  <strong>Edit this down.</strong> Keep what resonates, cut what doesn't.
</p>
```

**Step 3: Commit**

```bash
git add prompts/audience.json src/components/PersonificationReview.tsx && git commit -m "$(cat <<'EOF'
refactor(persona): set personification to concise mode

- 150-200 word limit in prompt
- Active instruction: "Edit this down"
- Positioned as thinking tool, not final output

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Theme D: Content Templates

### Task D1: Creative Task Standard Template

**Files:**
- Modify: `prompts/creative-task.json`
- Modify: `src/app/page.tsx`

**Step 1: Add default template to creative-task.json**

```json
{
  "section": "creative_task",
  "displayName": "Creative Task",

  "defaultTemplate": "Put forward 1-3 concepts that respond to [OBJECTIVES], including:\n- Creative overview\n- Insight used\n- Example executions across key channels\n- Campaign creative tenets",

  "assess": {
    // ... existing
  }
}
```

**Step 2: Load and display template in UI**

When reaching the creative_task section, show the template with editable fields:

```typescript
const CREATIVE_TASK_TEMPLATE = `Put forward 1-3 concepts that respond to [OBJECTIVES], including:
- Creative overview
- Insight used
- Example executions across key channels
- Campaign creative tenets`;

// In creative task section rendering
<div className="p-4 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)]">
  <p className="text-sm font-medium text-[var(--text-muted)] mb-2">Suggested creative task:</p>
  <textarea
    value={creativeTaskContent || CREATIVE_TASK_TEMPLATE}
    onChange={(e) => updateSection('creative_task', e.target.value)}
    className="w-full p-3 rounded-lg border border-[var(--border-color)] text-sm"
    rows={6}
  />
  <p className="text-xs text-[var(--text-muted)] mt-2">
    Edit as needed. This is a starting point, not a constraint.
  </p>
</div>
```

**Step 3: Commit**

```bash
git add prompts/creative-task.json src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(creative-task): add standard template

- Default template provided
- User confirms or amends
- Replaces scratch generation

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task D2: Audience Branching for Multiple Segments

**Files:**
- Modify: `src/lib/types.ts`
- Modify: `src/app/page.tsx`
- Modify: `src/components/AudienceMenu.tsx`

**Step 1: Update types for multi-audience flow**

```typescript
export interface AudienceBranch {
  segment: AudienceSegment;
  personification: PersonificationResponse | null;
  insights: Truth[];
}

// In SessionState
audienceBranches: AudienceBranch[]; // One per selected segment
currentBranchIndex: number;
```

**Step 2: Update flow for branching**

When multiple audiences selected:
1. Create a branch for each
2. Process personification for each separately
3. Generate insights for each separately
4. Merge at Creative Tenets step

**Step 3: Update UI to show branch progress**

```typescript
function BranchProgress({ branches, currentIndex }: { branches: AudienceBranch[]; currentIndex: number }) {
  return (
    <div className="flex items-center gap-2 mb-4">
      {branches.map((branch, i) => (
        <div
          key={i}
          className={`px-3 py-1 rounded-full text-xs ${
            i === currentIndex
              ? 'bg-[var(--expedia-navy)] text-white'
              : i < currentIndex
              ? 'bg-[var(--status-green)]/20 text-[var(--status-green)]'
              : 'bg-[var(--bg-tertiary)] text-[var(--text-muted)]'
          }`}
        >
          {branch.segment.name}
        </div>
      ))}
    </div>
  );
}
```

**Step 4: Commit**

```bash
git add src/lib/types.ts src/app/page.tsx src/components/AudienceMenu.tsx && git commit -m "$(cat <<'EOF'
feat(audience): implement branching for multiple segments

- Separate persona + insights per audience
- Visual branch progress indicator
- Merge at Creative Tenets stage

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Theme E: Export & Data

### Task E1: Confirm File Type Support (PDF, PowerPoint)

**Files:**
- Modify: `src/lib/file-parser.ts`
- Modify: `package.json`

**Step 1: Add PDF parsing dependency**

```bash
npm install pdf-parse
```

**Step 2: Add PowerPoint parsing dependency**

```bash
npm install officegen
```

**Step 3: Update file-parser.ts**

```typescript
import mammoth from 'mammoth';
import pdf from 'pdf-parse';

export async function parseFile(file: File): Promise<string> {
  const extension = file.name.split('.').pop()?.toLowerCase();
  const buffer = await file.arrayBuffer();

  switch (extension) {
    case 'txt':
      return new TextDecoder().decode(buffer);

    case 'doc':
    case 'docx':
      const docResult = await mammoth.extractRawText({ arrayBuffer: buffer });
      return docResult.value;

    case 'pdf':
      const pdfData = await pdf(Buffer.from(buffer));
      return pdfData.text;

    case 'ppt':
    case 'pptx':
      // PowerPoint extraction (simplified - extracts text only)
      // Note: Full PPTX parsing requires more complex handling
      return `[PowerPoint file: ${file.name}]\n[Text extraction from PPTX requires manual copy]`;

    default:
      throw new Error(`Unsupported file type: ${extension}`);
  }
}
```

**Step 4: Update FileUpload to show supported types**

```typescript
<p className="text-xs text-[var(--text-muted)]">
  Supports: .docx ‚úì, .pdf ‚úì, .txt ‚úì, .pptx (text only)
</p>
```

**Step 5: Commit**

```bash
git add src/lib/file-parser.ts package.json src/components/FileUpload.tsx && git commit -m "$(cat <<'EOF'
feat(upload): add PDF parsing support

- PDF text extraction via pdf-parse
- PPTX noted as text-only (manual copy recommended)
- Clear file type support indicators

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task E2: Data Capture and Logging

**Files:**
- Modify: `src/lib/types.ts`
- Create: `src/lib/analytics.ts`
- Modify: `src/app/page.tsx`

**Step 1: Enhance BriefScore type**

```typescript
export interface BriefScore {
  sessionId: string;
  sellerName?: string;
  briefFilename?: string;
  timestamp: string;
  gate1Scores: Record<Gate1SectionKey, Status>;
  gate1OverallHealth: string;
  completedSteps: Step[];
  timeSpentSeconds?: number;
}
```

**Step 2: Create analytics utility**

Create `src/lib/analytics.ts`:

```typescript
import { BriefScore, SessionState, GATE1_SECTION_KEYS, Status } from './types';

export function generateSessionId(): string {
  return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

export function captureBriefScore(state: SessionState): BriefScore {
  const gate1Scores: Record<string, Status> = {};

  for (const key of GATE1_SECTION_KEYS) {
    const section = state.sections.find(s => s.key === key);
    if (section) {
      gate1Scores[key] = section.status;
    }
  }

  return {
    sessionId: generateSessionId(),
    sellerName: state.briefScore?.sellerName,
    briefFilename: undefined, // Would need to track this
    timestamp: new Date().toISOString(),
    gate1Scores: gate1Scores as Record<any, Status>,
    gate1OverallHealth: state.triageResult?.overallBriefHealth || '',
    completedSteps: [], // Would track as user progresses
  };
}

export function logAnalytics(score: BriefScore): void {
  // For now, just console log
  // Could POST to analytics endpoint later
  console.log('[Analytics]', score);

  // Store in localStorage for potential export
  try {
    const existing = JSON.parse(localStorage.getItem('pitch_pack_analytics') || '[]');
    existing.push(score);
    localStorage.setItem('pitch_pack_analytics', JSON.stringify(existing.slice(-100)));
  } catch (e) {
    console.warn('Failed to store analytics:', e);
  }
}
```

**Step 3: Add seller name input**

In the upload step, add:

```typescript
<input
  type="text"
  placeholder="Seller name (optional, for tracking)"
  value={state.briefScore?.sellerName || ''}
  onChange={(e) => updateState({
    briefScore: { ...state.briefScore, sellerName: e.target.value, timestamp: '', gate1Scores: {} }
  })}
  className="w-full px-4 py-2 rounded-lg border border-[var(--border-color)] text-sm"
/>
```

**Step 4: Log on output generation**

In handleCompileOutput:

```typescript
logAnalytics(captureBriefScore(state));
```

**Step 5: Commit**

```bash
git add src/lib/types.ts src/lib/analytics.ts src/app/page.tsx && git commit -m "$(cat <<'EOF'
feat(analytics): implement brief score tracking

- Track session ID, seller name, scores
- Store in localStorage (last 100 sessions)
- Log on output generation

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task E3: Word Template Export

**Files:**
- Create: `src/lib/word-export.ts`
- Modify: `src/app/page.tsx`

**Step 1: Add docx dependency**

```bash
npm install docx file-saver
npm install --save-dev @types/file-saver
```

**Step 2: Create Word export utility**

Create `src/lib/word-export.ts`:

```typescript
import { Document, Paragraph, TextRun, HeadingLevel, Packer } from 'docx';
import { saveAs } from 'file-saver';
import { Section, AudienceSegment, Truth, BrandAlignment } from './types';

interface ExportData {
  sections: Section[];
  audience?: AudienceSegment;
  personification?: string;
  insights?: Truth[];
  brandAlignment?: BrandAlignment;
}

export async function exportToWord(data: ExportData): Promise<void> {
  const { sections, audience, personification, insights, brandAlignment } = data;

  const children: Paragraph[] = [
    new Paragraph({
      text: 'Creative Brief',
      heading: HeadingLevel.TITLE,
    }),
    new Paragraph({
      text: `Generated: ${new Date().toLocaleDateString()}`,
      spacing: { after: 400 },
    }),
  ];

  // Brand Alignment
  if (brandAlignment?.brand) {
    children.push(
      new Paragraph({ text: 'Brand', heading: HeadingLevel.HEADING_1 }),
      new Paragraph({ text: brandAlignment.brand.replace('_', '.') }),
    );
  }

  // Sections
  for (const section of sections) {
    if (section.content) {
      children.push(
        new Paragraph({ text: section.name, heading: HeadingLevel.HEADING_1 }),
        new Paragraph({ text: section.content }),
      );
    }
  }

  // Audience
  if (audience) {
    children.push(
      new Paragraph({ text: 'Audience', heading: HeadingLevel.HEADING_1 }),
      new Paragraph({ text: audience.name, heading: HeadingLevel.HEADING_2 }),
      new Paragraph({ text: audience.needsValues }),
    );
  }

  // Personification
  if (personification) {
    children.push(
      new Paragraph({ text: 'Personification', heading: HeadingLevel.HEADING_2 }),
      new Paragraph({ text: personification }),
    );
  }

  // Insights
  if (insights && insights.length > 0) {
    children.push(
      new Paragraph({ text: 'Audience Insights', heading: HeadingLevel.HEADING_1 }),
    );
    for (const insight of insights) {
      children.push(
        new Paragraph({
          children: [new TextRun({ text: `‚Ä¢ ${insight.text}` })],
        }),
      );
    }
  }

  const doc = new Document({
    sections: [{
      properties: {},
      children,
    }],
  });

  const blob = await Packer.toBlob(doc);
  saveAs(blob, `creative-brief-${Date.now()}.docx`);
}
```

**Step 3: Add Word export button to output step**

```typescript
<button
  onClick={() => exportToWord({
    sections: state.sections,
    audience: state.selectedAudienceSegment || undefined,
    personification: state.personification?.narrative,
    insights: state.selectedInsights,
    brandAlignment: state.brandAlignment || undefined,
  })}
  className="btn-outline flex items-center gap-2"
>
  <span>üìÑ</span>
  Export as Word
</button>
```

**Step 4: Commit**

```bash
git add src/lib/word-export.ts src/app/page.tsx package.json && git commit -m "$(cat <<'EOF'
feat(export): add Word document export

- Uses docx library for proper formatting
- Includes all sections, audience, insights
- Downloads as .docx file

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Final Tasks

### Task F1: Run Full Test Suite

**Step 1: Run tests**

```bash
cd /Users/will.bainbridge/Desktop/alive/ventures/audience-strategies/clients/expedia/pitch-pack-tool && npm test
```

**Step 2: Fix any failures**

Update tests for new types and components.

**Step 3: Commit fixes**

```bash
git add . && git commit -m "$(cat <<'EOF'
test: fix tests for v1.3 changes

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task F2: Manual Testing

**Step 1: Start dev server**

```bash
npm run dev
```

**Step 2: Test complete flow**

1. Upload multiple files
2. "Tell Me More" step
3. Triage with reassess
4. Research prompt suggestions
5. Section navigation
6. Undo/redo
7. Session persistence (refresh page)
8. Multiple audience branching
9. Creative task template
10. Word export
11. Save reminder

**Step 3: Fix any issues**

---

### Task F3: Build and Deploy

**Step 1: Build**

```bash
npm run build
```

**Step 2: Push**

```bash
git push origin main
```

**Step 3: Verify Railway deployment**

Check: https://pitch-pack-tool-production.up.railway.app

---

## Success Criteria Checklist

### Theme A: Enhanced Input Flow
- [ ] "Tell Me More" step before triage
- [ ] Reassess button with visual confirmation
- [ ] Research prompt suggestions based on gaps
- [ ] Multi-document upload
- [ ] URL handling guidance

### Theme B: Session & State
- [ ] Undo/redo functionality
- [ ] Save work reminder
- [ ] localStorage session persistence

### Theme C: UX Polish
- [ ] Clickable section names in navigation
- [ ] All wording changes complete
- [ ] "Keep refining or continue" on all sections
- [ ] Persona log line naming
- [ ] Personification concise mode

### Theme D: Content Templates
- [ ] Creative task standard template
- [ ] Audience branching for multiple segments

### Theme E: Export & Data
- [ ] PDF file support confirmed
- [ ] Data capture and logging
- [ ] Word document export

---

## Dependency Notes

1. **Theme A** is foundational ‚Äî complete first
2. **Theme B** (Task B3) enables Theme E (Task E2) ‚Äî session state needed for analytics
3. **Themes C and D** are independent ‚Äî can run in parallel
4. **Theme E** (Task E3) requires Expedia Word template for full styling ‚Äî placeholder template OK for now
